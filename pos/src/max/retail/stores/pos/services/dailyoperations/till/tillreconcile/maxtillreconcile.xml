<?xml version='1.0' ?>
<!--
/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
  Copyright (c) 2012-2013 MAXHyperMarket, Inc.    All Rights Reserved.
 
  Rev 1.4   Hitesh	28/feb/2017	   calling base PrintReceiptSite
  Rev 1.3   Nitesh	04/Jan/2017	    Changes done for Till Reconcilation
  Rev 1.2   Rahul Yadav	30/Apr/2015	    Changes done for stop Till Reconcilation at offline mode   
  Rev 1.1   Prateek		29/June/2013	Changes ddone for BUG 6660 & 6665
  Rev 1.0	Prateek		4/June/2013		Initial Draft: Changes for Till Reconcilation FES
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
-->
<!DOCTYPE SERVICE SYSTEM "classpath://oracle/retail/stores/foundation/tour/dtd/tourguide.dtd">

<SERVICE name="TillReconcile" package="oracle.retail.stores.pos.services.dailyoperations.till.tillreconcile" tourcam="OFF">
     <COMMENT>
          Service called when reconciling a Till.
     </COMMENT>
<CARGO class="TillReconcileCargo">
</CARGO>
<SERVICECODE>
     <LETTER name="Success"/>
     <LETTER name="Failure"/>
     <LETTER name="Yes"/>
     <LETTER name="No"/>
     <LETTER name="Ok"/>
     <LETTER name="Cancel"/>
     <LETTER name="Undo"/>
     <LETTER name="Retry"/>
     <LETTER name="Next"/>
     <LETTER name="Continue"/>
     <LETTER name="TillError"/>
     <LETTER name="DbError"/>
     <LETTER name="RegisterClosedError"/>
     <LETTER name="UpdateError"/>
     <LETTER name="Default"/>
     <LETTER name="Override"/>
     <LETTER name="TillOpen"/>
     <!--Changes done for HDD Full Patch From Oracle Start-->
     <LETTER name="QueueFull"/>
     <!--Changes done for HDD Full Patch From Oracle End-->

     <SITEACTION class="OfflineWarningSite" />
     <SITEACTION class="CheckRegisterStatusSite" />
     <SITEACTION class="EnterTillSite" />
     <SITEACTION class="DisplayCloseTillDialogSite" />
     <SITEACTION class="OpenDrawerSite" />
     <SITEACTION class="TillReconcileOptionSite" />
     <SITEACTION class="CheckCountFloatSite" />
     <SITEACTION class="CloseDrawerSite" />
     <SITEACTION class="PrintReceiptSite" />
     <SITEACTION class="MAXUpdateStatusSite" package="max.retail.stores.pos.services.dailyoperations.till.tillreconcile"/>
     <SITEACTION class="MAXPrintReceiptSite" package="max.retail.stores.pos.services.dailyoperations.till.tillreconcile"/>
     <!--MAX Rev 1.2 Change : Start-->
     <SITEACTION class="MAXOfflineWarningSite" package="max.retail.stores.pos.services.dailyoperations.till.tillreconcile"/>
     <!--MAX Rev 1.2 Change : Ends-->
     <SITEACTION class="CheckCountTillSite" />
     <SITEACTION class="WriteHardTotalsSite" package="oracle.retail.stores.pos.services.common" />
	 <!--MAX Rev 1.1 Change : Start-->
     <SITEACTION class="MAXPrintReportsSite" package="max.retail.stores.pos.services.dailyoperations.till.tillreconcile"/>
 	 <!--MAX Rev 1.1 Change : Start-->
     <SITEACTION class="CheckAccessSite" package="oracle.retail.stores.pos.services.admin.security.common" />
     <SITEACTION class="CheckTillInDrawerSite" />

     <SHUTTLE class="PosCountFloatLaunchShuttle" />
     <SHUTTLE class="PosCountFloatReturnShuttle" />
     <SHUTTLE class="PosCountTillLaunchShuttle" />
     <SHUTTLE class="MAXPosCountTillReturnShuttle" package = "max.retail.stores.pos.services.dailyoperations.till.tillreconcile"/>
     <SHUTTLE class="SecurityOverrideLaunchShuttle" package="oracle.retail.stores.pos.services.admin.security.common" />
     <SHUTTLE class="TillCloseLaunchShuttle" />
     <SHUTTLE class="TillCloseReturnShuttle" />

     <LANEACTION class="TillEnteredAisle" />
     <LANEACTION class="EnterTillErrorOkAisle" />
     <LANEACTION class="UpdateStatusErrorAisle" />
     <LANEACTION class="DisplayErrorAisle" package="oracle.retail.stores.pos.services.dailyoperations.till" />     
     <LANEACTION class="EnterTillTillAlreadyClosedErrorAisle" />
     <LANEACTION class="CheckStatusRegisterOpenErrorAisle" />
     <LANEACTION class="CheckStatusRegisterClosedErrorAisle" />
     <LANEACTION class="OkToFailureConversionAisle" package="oracle.retail.stores.pos.services.common" />
     <LANEACTION class="FloatCountSucceededRoad" />
     <LANEACTION class="MAXTillCountSucceededRoad" package = "max.retail.stores.pos.services.dailyoperations.till.tillreconcile" />
     <LANEACTION class="WriteHardTotalsErrorAisle" package="oracle.retail.stores.pos.services.common" />
     <LANEACTION class="FailureConversionAisle" package="oracle.retail.stores.pos.services.common" />
     <LANEACTION class="CancelLetterAisle" package="oracle.retail.stores.pos.services.common" />
     <LANEACTION class="DataBaseErrorAisle" package="oracle.retail.stores.pos.services.common" template="laneaction.tpl" />
     <LANEACTION class="TillCloseDefaultAccessErrorAisle" />
     <LANEACTION class="ReconcileTillRoad" />
     <LANEACTION class="CloseTillRoad" />
     <LANEACTION class="CheckCloseTillAccessAisle" />
     <LANEACTION class="RemoveTillRoad" package="oracle.retail.stores.pos.services.dailyoperations.common"/>

     <SIGNAL class="IsTillReconciledSignal" />
     <SIGNAL class="IsRequestedServiceTillReconcileSignal"/>
</SERVICECODE>
<MAP>
     <REGION region="SERVICE" startsite="CheckAccess">
            <SITE name="CheckAccess" siteaction="CheckAccessSite">
                <ROAD
                    name="NoAccess"
                    letter="Override"
                    destination="SecurityOverrideStation">
                </ROAD>
                     <!--MAX Rev 1.2 Change : Start-->
                <!-- <ROAD
                    name="TillReconcileAuthorized"
                    letter="Continue"
                    destination="CheckOfflineStatus">
                </ROAD> -->
                <ROAD
                    name="TillReconcileAuthorized"
                    letter="Continue"
                    destination="MAXCheckOfflineStatus">
                </ROAD> 
                <!--MAX Rev 1.2 Change : Ends-->
                
            </SITE>
            <STATION name="SecurityOverrideStation"
                servicename="security.override.override"
                targettier="CURRENTTIER"
                launchshuttle="SecurityOverrideLaunchShuttle" >
		<!--changes for till reconcillation starts -->
                <ROAD
                    name="TillReconcileSucceededSecurityOverride"
                    letter="Success"
                    destination="MAXCheckOfflineStatus"
                    tape="ADVANCE" record="OFF" index="OFF">
                </ROAD>
		<!--changes for till reconcillation ends -->
                <ROAD
                    name="SecurityOverrideFailed"
                    letter="Failure"
                    destination="Final"
                    tape="ADVANCE" record="OFF" index="OFF">
                </ROAD>
                <ROAD
                    name="SecurityOverrideCancelled"
                    letter="Cancel"
                    destination="Final"
                    tape="ADVANCE" record="OFF" index="OFF">
                </ROAD>
          </STATION>
          <SITE name="CheckOfflineStatus" siteaction="OfflineWarningSite">
               <ROAD name="CheckOfflineFailure"
                     letter="Failure"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="CheckOfflineSuccess"
                     letter="Success"
                     destination="CheckRegisterStatus"
                     tape="ADVANCE" record="ON" index="ON">
                     <LIGHT signal="IsRequestedServiceTillReconcileSignal"/>
                     <COMMENT>
                         Requesting service is Till Reconcile.
                     </COMMENT>
               </ROAD>
               <ROAD name="CheckOfflineSuccessForTillClose"
                     letter="Success"
                     destination="CheckTillInDrawer"
                     tape="ADVANCE" record="ON" index="ON">
                     <LIGHT signal="IsRequestedServiceTillReconcileSignal" negate="Y"/>
                     <COMMENT>
                         Requesting service is Till Close
                     </COMMENT>
               </ROAD>
          </SITE>   
         <!--MAX Rev 1.2 Change : Start-->
          <SITE name="MAXCheckOfflineStatus" siteaction="MAXOfflineWarningSite">
               <ROAD name="CheckOfflineFailure"
                     letter="Failure"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="CheckOfflineSuccess"
                     letter="Success"
                     destination="CheckRegisterStatus"
                     tape="ADVANCE" record="ON" index="ON">
                     <LIGHT signal="IsRequestedServiceTillReconcileSignal"/>
                     <COMMENT>
                         Requesting service is Till Reconcile.
                     </COMMENT>
               </ROAD>
               <ROAD name="CheckOfflineSuccessForTillClose"
                     letter="Success"
                     destination="CheckTillInDrawer"
                     tape="ADVANCE" record="ON" index="ON">
                     <LIGHT signal="IsRequestedServiceTillReconcileSignal" negate="Y"/>
                     <COMMENT>
                         Requesting service is Till Close
                     </COMMENT>
               </ROAD>
          </SITE>
      <!--MAX Rev 1.2 Change : Ends-->
         
          <SITE name="CheckRegisterStatus" siteaction="CheckRegisterStatusSite">
               <AISLE name="CheckRegisterStatusDatabaseError"
                      letter="DbError"
                      laneaction="DisplayErrorAisle">
               </AISLE>
               <AISLE name="CheckRegisterStatusRegisterClosedError"
                      letter="RegisterClosedError"
                      laneaction="DisplayErrorAisle">
               </AISLE>               
               <AISLE name="CheckRegisterStatusErrorOk"
                      letter="Ok"
                      laneaction="FailureConversionAisle">
                    <COMMENT>
                         Check error condition and send Continue or Exit letter.
                    </COMMENT>
               </AISLE>
               <ROAD name="CheckRegisterStatusContinue"
                      letter="Continue"
                      destination="EnterTill" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="CheckRegisterStatusExit"
                      letter="Failure"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>
          <SITE name="EnterTill" siteaction="EnterTillSite">
               <AISLE name="TillEntered"
                      letter="Next"
                      laneaction="TillEnteredAisle">
               </AISLE>
               <AISLE name="EnterTillError"
                      letter="TillError"
                      laneaction="DisplayErrorAisle">
               </AISLE>
               <ROAD name="EnterTillErrorOk"
                      letter="Ok"
                      destination="EnterTill" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillExit"
                      letter="Failure"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillUndo"
                      letter="Undo"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillCancel"
                      letter="Cancel"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillTillOpen"
                      letter="TillOpen"
                      destination="DisplayCloseTillDialog" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillContinue"
                      letter="Continue"
                      destination="CheckTillInDrawer" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="EnterTillRetry"
                      letter="Retry"
                      destination="EnterTill" tape="ADVANCE" record="ON" index="ON">
               </ROAD>               
          </SITE>
          
          <SITE name="DisplayCloseTillDialog" siteaction="DisplayCloseTillDialogSite">
               <ROAD name="CloseTillDialogNo"
                      letter="No"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="CloseTillDialogYes"
                      letter="Yes"
                      laneaction="CheckCloseTillAccessAisle"
                      destination="CloseTillStation" record="ON" index="ON">
               </ROAD>  
          </SITE>
          
          <STATION name="CloseTillStation"
                   servicename="till.tillclose.tillclose"
                   targettier="CURRENTTIER"
                   launchshuttle="TillCloseLaunchShuttle"
                   returnshuttle="TillCloseReturnShuttle">
               <ROAD name="TillCloseSucceeded"
                     letter="Success"
                     destination="CheckTillInDrawer"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillCloseFailed"
                     letter="Failure"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillCloseUndo"
                     letter="Undo"
                     destination="EnterTill"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillCloseCancelled"
                     letter="Cancel"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
	       <!--Changes done for HDD Full Patch From Oracle Start-->
               <ROAD name="TillCloseQueueFull"
                     letter="QueueFull"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
	       <!--Changes done for HDD Full Patch From Oracle End-->
          </STATION>
          
          <SITE name="CheckTillInDrawer" siteaction="CheckTillInDrawerSite">
               <ROAD name="CheckTillInDrawerNo"
                      letter="No"
                      destination="CheckCountFloat" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="CheckTillInDrawerYes"
                      letter="Yes"
                      laneaction="RemoveTillRoad"
                      destination="OpenDrawer" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>          
          
          <SITE name="OpenDrawer" siteaction="OpenDrawerSite">
               <AISLE name="OpenDrawerFailureConversion"
                      letter="Cancel"
                      laneaction="FailureConversionAisle">
                    <COMMENT>
                         converts Cancel to Failure
                    </COMMENT>
               </AISLE>
               <ROAD name="OpenDrawerContinue"
                      letter="Continue"
                      destination="CheckCountFloat"
                      tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="OpenDrawerRetry"
                      letter="Retry"
                      destination="OpenDrawer"
                      tape="ADVANCE" record="ON" index="ON">
                    <COMMENT>
                         users selects Retry when cash drawer has a device
                         exception
                    </COMMENT>
               </ROAD>
               <ROAD name="OpenDrawerFailure"
                      letter="Failure"
                      destination="Final"
                      tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>
          <SITE name="CloseDrawer" siteaction="CloseDrawerSite">
               <ROAD name="DrawerClosed"
                     letter="Continue"
                     destination="UpdateStatus"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>

          <SITE name="CheckCountFloat" siteaction="CheckCountFloatSite">
               <ROAD name="FloatCount"
                     letter="Yes"
                     destination="PosCountFloatStation"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="FloatNoCount"
                     letter="No"
                     destination="CheckCountTill"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>
          <STATION name="PosCountFloatStation"
                   servicename="dailyoperations.poscount.poscount"
                   targettier="CURRENTTIER"
                   launchshuttle="PosCountFloatLaunchShuttle"
                   returnshuttle="PosCountFloatReturnShuttle">
               <ROAD name="FloatCountSucceeded"
                     letter="Success"
                     laneaction="FloatCountSucceededRoad"
                     destination="CheckCountTill" 
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="FloatCountUndo"
                     letter="Undo"
                     destination="EnterTill"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="FloatCountCancelled"
                     letter="Cancel"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </STATION>
          <SITE name="CheckCountTill" siteaction="CheckCountTillSite">
               <ROAD name="TillCount"
                     letter="Yes"
                     destination="PosCountTillStation"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillNoCount"
                     letter="No"
                     destination="CloseDrawer"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>
          <STATION name="PosCountTillStation"
                   servicename="dailyoperations.poscount.poscount"
                   targettier="CURRENTTIER"
                   launchshuttle="PosCountTillLaunchShuttle"
                   returnshuttle="MAXPosCountTillReturnShuttle">
               <ROAD name="TillCountSucceeded"
                     letter="Success"
                     laneaction="MAXTillCountSucceededRoad"
                     destination="CloseDrawer" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillCountUndo"
                     letter="Undo"
                     destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="TillCountCancelled"
                     letter="Cancel"
                     destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </STATION>

          <SITE name="UpdateStatus" siteaction="MAXUpdateStatusSite">
               <AISLE name="UpdateStatusError"
                      letter="UpdateError"
                      laneaction="UpdateStatusErrorAisle">
               </AISLE>
               <AISLE name="UpdateStatusErrorOk"
                      letter="Ok"
                      laneaction="FailureConversionAisle">
               </AISLE>
               <ROAD name="UpdateSucceeded"
                      letter="Success"
                      destination="WriteHardTotals"
                      tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="UpdateFailed"
                      letter="Failure"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
	       <!--Changes done for HDD Full Patch From Oracle Start-->
               <ROAD name="UpdateStatusRetry"
                      letter="Retry"
                      destination="UpdateStatus" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="UpdateStatusQueueFull"
                     letter="QueueFull"
                     destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
	       <!--Changes done for HDD Full Patch From Oracle End-->
          </SITE>
          <!--Changes for rev 1.4-->
          <SITE name="PrintReceipt" siteaction="PrintReceiptSite">
               <AISLE name="PrintReceiptFailureConversion"
                      letter="Continue"
                      laneaction="FailureConversionAisle">
                    <COMMENT>
                         converts Cancel to Failure
                    </COMMENT>
               </AISLE>
               <ROAD name="PrintTillReport"
                      letter="Success"
                      destination="PrintReport" tape="ADVANCE" record="ON" index="ON">
                    <COMMENT>
                        Only print a Till Reconcile report if the till was reconciled.
                    </COMMENT>
                    <LIGHT signal="IsTillReconciledSignal"/>
               </ROAD>
               <ROAD name="FinishUp"
                      letter="Success"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
                    <LIGHT signal="IsTillReconciledSignal" negate="Y"/>
               </ROAD>
               <ROAD name="PrintReceiptFailure"
                      letter="Failure"
                      destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="RetryPrintReceipt"
                      letter="Retry"
                      destination="PrintReceipt" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>


          <SITE name="WriteHardTotals" siteaction="WriteHardTotalsSite">
               <AISLE name="WriteHardTotalsError"
                      letter="Failure"
                      laneaction="WriteHardTotalsErrorAisle">
               </AISLE>
               <AISLE name="WriteHardTotalsErrorOk"
                      letter="Ok"
                      laneaction="FailureConversionAisle">
               </AISLE>
               <ROAD name="WriteHardTotalsSucceeded"
                     letter="Success"
                     destination="PrintReceipt" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="WriteHardTotalsFailed"
                     letter="Failure"
                     destination="Final" tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>

          <SITE name="PrintReport" siteaction="MAXPrintReportsSite">
               <COMMENT>
                    this site deals with printing the automatic till
                    summary report
               </COMMENT>
               <AISLE name="PrintReportFailureConversion"
                      letter="Continue"
                      laneaction="FailureConversionAisle">
               </AISLE>
               <ROAD name="RetryPrintReport"
                     letter="Retry"
                     destination="PrintReport"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="ReportPrinted"
                     letter="Success"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
               <ROAD name="PrintReportFailure"
                     letter="Failure"
                     destination="Final"
                     tape="ADVANCE" record="ON" index="ON">
               </ROAD>
          </SITE>
          <SYSTEMSITE name="Final" action="RETURN">
          </SYSTEMSITE>
          <SYSTEMSITE name="LastIndexed" action="BACKUP">
          </SYSTEMSITE>
     </REGION>
</MAP>
</SERVICE>
